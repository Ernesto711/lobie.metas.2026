<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOBIE | Painel de Metas 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#ffffff;--bg2:#fafafa;--bg3:#efefef;--card:#ffffff;--border:#d4d4d4;--text:#0a0a0a;--text2:#525252;--blue:#171717;--green:#16a34a;--red:#dc2626;--amber:#d97706;--cyan:#0891b2;--purple:#7c3aed;--magenta:#db2777;--accent:#000000}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Syne',sans-serif;background:var(--bg);color:var(--text)}
.shell{display:flex;flex-direction:column;height:100vh;max-height:100vh}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 24px;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);flex-shrink:0;height:48px;z-index:10}
.logo{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.logo span{color:var(--text2);font-weight:400;font-size:11px;margin-left:8px;letter-spacing:1px;text-transform:uppercase}
.topbar-r{display:flex;gap:6px;align-items:center}
.sel{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:50px;font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;transition:border-color .2s}
.sel:hover{border-color:var(--accent)}
.btn{padding:6px 14px;border-radius:50px;border:1px solid var(--border);font-family:'Syne',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;background:var(--bg);color:var(--text)}
.btn:hover{border-color:var(--accent);background:var(--bg3)}
.btn-p{background:var(--accent);color:#fff;border-color:var(--accent)}.btn-p:hover{background:#333}
.btn-g{background:var(--green);color:#fff;border-color:var(--green)}.btn-g:hover{opacity:.9}
.btn-o{background:transparent;border:1px solid var(--border);color:var(--text2)}.btn-o:hover{border-color:var(--accent);color:var(--text)}

/* TABS */
.tabs{display:flex;gap:0;padding:0 24px;background:var(--bg);border-bottom:1px solid var(--border);flex-shrink:0;height:38px}
.tab{padding:10px 18px;font-size:13px;font-weight:600;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;letter-spacing:.3px}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* VIEWS */
.view{flex:1;padding:12px 20px;display:none;overflow:hidden}.view.active{display:flex;flex-direction:column}

/* OPERACIONAL */
.op-top{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;flex:1;min-height:0}
.cluster{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;overflow:hidden;transition:border-color .2s}
.cluster:hover{border-color:var(--accent)}
.cluster-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-shrink:0}
.cluster-name{font-size:15px;font-weight:700;display:flex;align-items:center;gap:6px}
.cluster-name .ico{font-size:16px}
.cluster-badge{font-size:11px;padding:3px 10px;border-radius:50px;font-weight:700;letter-spacing:.3px}
.badge-g{background:#f0fdf4;color:var(--green);border:1px solid #bbf7d0}
.badge-r{background:#fef2f2;color:var(--red);border:1px solid #fecaca}
.badge-a{background:#fffbeb;color:var(--amber);border:1px solid #fde68a}
.cluster-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;flex-shrink:0}
.ckpi{background:var(--bg3);border-radius:12px;padding:8px 10px;text-align:center}
.ckpi-l{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px;font-weight:700}
.ckpi-v{font-family:'Space Mono',monospace;font-size:17px;font-weight:700}
.emp-list{flex:1;overflow:hidden}
.emp-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:4px;padding:5px 6px;font-size:12px;border-bottom:1px solid var(--bg3);align-items:center}
.emp-row:last-child{border:none}
.emp-row.hdr{color:var(--text2);font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:700;padding-bottom:3px;border-bottom:1px solid var(--border)}
.emp-name{font-weight:700;font-size:12px}.emp-val{font-family:'Space Mono',monospace;text-align:center;font-size:12px;font-weight:600}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
.dot-g{background:var(--green)}.dot-r{background:var(--red)}.dot-a{background:var(--amber)}

.op-bottom{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px;flex-shrink:0}
.mkpi{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px 14px;position:relative;overflow:hidden;transition:border-color .2s}
.mkpi:hover{border-color:var(--accent)}
.mkpi-l{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;font-weight:700}
.mkpi-v{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;margin:3px 0}
.mkpi-t{font-size:10px;color:var(--text2);font-weight:500}
.mkpi-bar{height:5px;background:var(--bg3);border-radius:2px;margin-top:6px;overflow:hidden}
.mkpi-bar-f{height:100%;border-radius:2px;transition:width .8s}

/* DIRETORIA */
.dir-top{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;flex-shrink:0;margin-bottom:10px}
.dir-mid{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:10px;flex:1;min-height:0}
.dir-chart{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;transition:border-color .2s}
.dir-chart:hover{border-color:var(--accent)}
.dir-chart-title{font-size:13px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.dir-chart-title .cdot{width:8px;height:8px;border-radius:50%}
.dir-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;flex-shrink:0}
.area-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px 14px;transition:border-color .2s}
.area-card:hover{border-color:var(--accent)}
.area-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.area-nm{font-size:13px;font-weight:700}
.area-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid var(--bg3)}.area-row:last-child{border:none}
.area-rl{color:var(--text2);font-weight:500}.area-rv{font-family:'Space Mono',monospace;font-weight:700}

svg text{font-family:'Syne',sans-serif}

/* CONFIG */
.cfg-sup{background:var(--bg3);border-radius:12px;padding:12px;margin-bottom:8px;border-left:3px solid var(--accent)}
.cfg-sup-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.cfg-sup-name{font-weight:700;font-size:13px}
.cfg-emp-tag{display:inline-flex;align-items:center;gap:4px;background:var(--card);border:1px solid var(--border);border-radius:50px;padding:4px 10px;font-size:11px;margin:2px 4px 2px 0;transition:border-color .2s}
.cfg-emp-tag:hover{border-color:var(--accent)}
.cfg-emp-tag .x{cursor:pointer;color:var(--red);font-weight:700;font-size:12px;margin-left:2px;opacity:.7}.cfg-emp-tag .x:hover{opacity:1}
.cfg-emp-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg3);border-radius:12px;margin-bottom:4px;font-size:12px}
.cfg-sel{background:var(--card);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:50px;font-size:11px;font-family:'Syne',sans-serif}

/* COMERCIAL */
.com-top{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;flex-shrink:0;margin-bottom:10px}
.com-mid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;flex:1;min-height:0}
.vcard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;transition:border-color .2s}
.vcard:hover{border-color:var(--accent)}
.vcard-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.vcard-name{font-size:13px;font-weight:700}
.vcard-rate{font-family:'Space Mono',monospace;font-size:24px;font-weight:700;text-align:center;margin:4px 0}
.vcard-bar{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;margin:4px 0}
.vcard-bar-f{height:100%;border-radius:4px;transition:width .8s}
.vcard-stats{display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:10px;margin-top:auto}
.vcard-stat{background:var(--bg3);border-radius:8px;padding:6px 8px;text-align:center}
.vcard-stat-l{color:var(--text2);font-size:9px;text-transform:uppercase;letter-spacing:.3px;font-weight:700}
.vcard-stat-v{font-family:'Space Mono',monospace;font-weight:700;font-size:13px}
.com-bottom{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;flex-shrink:0}

/* MODAL */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:200;justify-content:center;align-items:flex-start;padding-top:2vh;overflow-y:auto;backdrop-filter:blur(6px)}.modal-ov.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;width:780px;max-height:94vh;overflow-y:auto;padding:24px;box-shadow:0 25px 50px -12px rgba(0,0,0,.15)}
.modal h2{font-size:16px;font-weight:800;margin-bottom:2px}
.modal .sub{color:var(--text2);font-size:12px;margin-bottom:14px}
.fsec{margin-bottom:14px}
.fsec-t{font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:4px}
.fg{display:flex;flex-direction:column;gap:2px}
.fg label{font-size:10px;color:var(--text2);font-weight:600}
.fg input{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;font-family:'Space Mono',monospace;font-size:12px;transition:border-color .2s}
.fg input:focus{outline:none;border-color:var(--accent);background:var(--bg)}
.factions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
.emp-hdr{font-size:11px;font-weight:700;color:var(--accent);margin:8px 0 4px;padding:4px 0;border-bottom:1px solid var(--border)}

/* HIST TABLE */
.htbl th{font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:700;color:var(--text2);padding:6px;text-align:center}
.htbl td{font-family:'Space Mono',monospace;font-size:12px}

/* TV MODE */
body.tv .topbar .btn,body.tv .sel:first-of-type{display:none}

/* Scrollbar */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg3)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--text2)}
</style>
</head>
<body>
<div class="shell">
  <div class="topbar">
    <div class="logo">LOBIE <span>Metas 2026</span></div>
    <div class="topbar-r">
      <select class="sel" id="mSel"></select>
      <button class="btn btn-p" onclick="openM('g')">＋ Dados</button>
      <button class="btn" style="background:var(--purple);color:#fff;border-color:var(--purple)" onclick="openM('c')">Comercial</button>
      <button class="btn btn-g" onclick="openM('o')">Operacional</button>
      <button class="btn btn-o" onclick="toggleTV()">TV</button>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="sw(this,'op')">Operacional</div>
    <div class="tab" onclick="sw(this,'com')">Comercial</div>
    <div class="tab" onclick="sw(this,'dir')">Diretoria</div>
    <div class="tab" onclick="sw(this,'cfg')">Gestão</div>
    <div class="tab" onclick="sw(this,'hist')">Histórico</div>
  </div>

  <div class="view active" id="opV">
    <div class="op-top" id="clusters"></div>
    <div class="op-bottom" id="opKpis"></div>
  </div>

  <div class="view" id="comV">
    <div class="com-top" id="comKpis"></div>
    <div class="com-mid" id="comCards"></div>
    <div class="com-bottom" id="comBottom"></div>
  </div>

  <div class="view" id="dirV">
    <div class="dir-top" id="dirKpis"></div>
    <div class="dir-mid">
      <div class="dir-chart"><div class="dir-chart-title"><div class="cdot" style="background:var(--accent)"></div>UHs com Repasse</div><div id="chUhs" style="flex:1"></div></div>
      <div class="dir-chart"><div class="dir-chart-title"><div class="cdot" style="background:var(--green)"></div>Margem (%)</div><div id="chMarg" style="flex:1"></div></div>
      <div class="dir-chart"><div class="dir-chart-title"><div class="cdot" style="background:var(--purple)"></div>Bônus Diretores</div><div id="dirBonus" style="flex:1"></div></div>
    </div>
    <div class="dir-bottom" id="dirAreas"></div>
  </div>

  <div class="view" id="histV">
    <div class="dir-chart" style="flex:1;overflow:auto"><div class="dir-chart-title">Histórico Mensal</div><div style="overflow:auto;flex:1"><table class="htbl" id="hTbl" style="width:100%;border-collapse:collapse;font-size:11px"></table></div></div>
  </div>

  <div class="view" id="cfgV">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1;min-height:0;overflow:hidden">
      <div class="dir-chart" style="overflow:auto">
        <div class="dir-chart-title" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:6px"><div class="cdot" style="background:var(--accent)"></div>Supervisores & Atribuições</div><button class="btn btn-p" style="font-size:10px;padding:4px 12px" onclick="addSup()">＋ Supervisor</button></div>
        <div id="cfgSups"></div>
      </div>
      <div class="dir-chart" style="overflow:auto">
        <div class="dir-chart-title" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:6px"><div class="cdot" style="background:var(--green)"></div>Empreendimentos</div><button class="btn btn-g" style="font-size:10px;padding:4px 12px" onclick="addEmp()">＋ Empreendimento</button></div>
        <div id="cfgEmps"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL GERAL -->
<div class="modal-ov" id="mG"><div class="modal">
  <h2>Dados Gerais</h2><div class="sub" id="mGm"></div>
  <div class="fsec"><div class="fsec-t">Empresa</div>
    <div class="frow"><div class="fg"><label>UHs com Repasse</label><input type="number" id="g_uhs"></div><div class="fg"><label>Faturamento Lobie (R$)</label><input type="number" id="g_fat"></div></div>
    <div class="frow"><div class="fg"><label>Resultado (R$)</label><input type="number" id="g_res"></div><div class="fg"><label>Ocupação (%)</label><input type="number" id="g_ocup" step="0.1"></div></div>
  </div>
  <div class="fsec"><div class="fsec-t">Comercial</div>
    <div class="frow"><div class="fg"><label>Novas Assinaturas</label><input type="number" id="g_assin"></div><div class="fg"><label>Novas UHs no Repasse</label><input type="number" id="g_novas"></div></div>
    <div class="frow"><div class="fg"><label>Distratos</label><input type="number" id="g_distr"></div><div class="fg"><label></label></div></div>
  </div>
  <div class="fsec"><div class="fsec-t">RI</div>
    <div class="frow"><div class="fg"><label>Churn (%)</label><input type="number" id="g_churn" step="0.1"></div><div class="fg"><label>NPS</label><input type="number" id="g_nps"></div></div>
    <div class="frow"><div class="fg"><label>Reports Enviados (%)</label><input type="number" id="g_rep"></div><div class="fg"><label>Tempo Resposta (h)</label><input type="number" id="g_tresp"></div></div>
  </div>
  <div class="factions"><button class="btn btn-o" onclick="closeM()">Cancelar</button><button class="btn" style="background:var(--red);color:#fff;border-color:var(--red)" onclick="delM('g')">Apagar</button><button class="btn btn-p" onclick="saveG()">Salvar</button></div>
</div></div>

<!-- MODAL COMERCIAL -->
<div class="modal-ov" id="mC"><div class="modal">
  <h2>Comercial por Vendedor</h2><div class="sub" id="mCm"></div>
  <div id="cForm"></div>
  <div class="factions"><button class="btn btn-o" onclick="closeM()">Cancelar</button><button class="btn" style="background:var(--red);color:#fff;border-color:var(--red)" onclick="delM('c')">Apagar</button><button class="btn btn-p" onclick="saveC()">Salvar</button></div>
</div></div>

<!-- MODAL OPERACIONAL -->
<div class="modal-ov" id="mO"><div class="modal">
  <h2>Operacional por Empreendimento</h2><div class="sub" id="mOm"></div>
  <div id="oForm"></div>
  <div class="factions"><button class="btn btn-o" onclick="closeM()">Cancelar</button><button class="btn" style="background:var(--red);color:#fff;border-color:var(--red)" onclick="delM('o')">Apagar</button><button class="btn btn-p" onclick="saveO()">Salvar</button></div>
</div></div>

<script>
const E_DEFAULT=[
  {id:'casa_maua',n:'Casa Mauá',s:'Geisiane',bl:49},
  {id:'skylux',n:'Skylux',s:'Cadu',bl:76},
  {id:'botafogo',n:'Botafogo Priv.',s:'Guilherme/Léo',bl:35},
  {id:'gloria',n:'Glória',s:'Cadu',bl:36},
  {id:'vilares',n:'Vilares',s:'Guilherme/Léo',bl:34},
  {id:'dias',n:'Dias',s:'Cadu',bl:33},
  {id:'mediterraneo',n:'Mediterrâneo',s:'Guilherme/Léo',bl:41},
  {id:'mundo_novo',n:'Mundo Novo',s:'Guilherme/Léo',bl:39},
  {id:'queen',n:'Queen Ipanema',s:'Guilherme/Léo',bl:51},
];
const SUPS_DEFAULT=[
  {name:'Cadu',ico:'●',emps:['skylux','gloria','dias']},
  {name:'Guilherme/Léo',ico:'●',emps:['botafogo','vilares','mediterraneo','mundo_novo','queen']},
  {name:'Geisiane',ico:'●',emps:['casa_maua']},
];
const ICOS=['●','●','●','●','●','●','●','●'];
const cfgK='l26cfg';
function loadCfg(){try{return JSON.parse(localStorage.getItem(cfgK))||null}catch{return null}}
function saveCfg(c){localStorage.setItem(cfgK,JSON.stringify(c))}
function getCfg(){const c=loadCfg();return c||{emps:E_DEFAULT,sups:SUPS_DEFAULT}}
let E,SUPS;
function refreshCfg(){const c=getCfg();E=c.emps;SUPS=c.sups}
refreshCfg();
const MP=['','Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const T={s1:{uhs:400,fat:500000,mg:15,co:38,nota:8.3,novas:20,assin:30,churn:2,fatUh:1300,lucUh:187},s2:{uhs:500,fat:650000,mg:20,co:35,nota:8.5,novas:25,assin:30,churn:1.5,fatUh:1300,lucUh:260}};
const BL={
'2023-01':{uhs:107,fat:153703,res:62520},'2023-02':{uhs:114,fat:193267,res:100824},'2023-03':{uhs:121,fat:181350,res:87647},
'2023-04':{uhs:115,fat:146431,res:53808},'2023-05':{uhs:118,fat:143831,res:50668},'2023-06':{uhs:120,fat:120869,res:27346},
'2023-07':{uhs:120,fat:137222,res:43699},'2023-08':{uhs:128,fat:147304,res:52341},'2023-09':{uhs:123,fat:145239,res:51176},
'2023-10':{uhs:123,fat:174300,res:80237},'2023-11':{uhs:132,fat:207458,res:111775},'2023-12':{uhs:130,fat:152905,res:49172},
'2024-01':{uhs:132,fat:207919,res:84984},'2024-02':{uhs:132,fat:202672,res:85915},'2024-03':{uhs:130,fat:161788,res:37376},
'2024-04':{uhs:127,fat:146686,res:-2352},'2024-05':{uhs:138,fat:140763,res:14419},'2024-06':{uhs:147,fat:145455,res:24916},
'2024-07':{uhs:156,fat:169329,res:-677},'2024-08':{uhs:165,fat:177607,res:46401},'2024-09':{uhs:191,fat:241250,res:63190},
'2024-10':{uhs:196,fat:226430,res:32197},'2024-11':{uhs:200,fat:280330,res:98828},'2024-12':{uhs:229,fat:235373,res:16340},
'2025-01':{uhs:250,fat:374156,res:118747},'2025-02':{uhs:249,fat:315720,res:56766},'2025-03':{uhs:256,fat:493747,res:166644},
'2025-04':{uhs:265,fat:327792,res:-34129},'2025-05':{uhs:259,fat:351141,res:7360},'2025-06':{uhs:259,fat:351428,res:90397},
'2025-07':{uhs:248,fat:337904,res:-129121},'2025-08':{uhs:283,fat:351106,res:-5380},'2025-09':{uhs:299,fat:338221,res:-21462},
'2025-10':{uhs:309,fat:392055,res:1375},'2025-11':{uhs:317,fat:377984,res:-35986},'2025-12':{uhs:327,fat:388757,res:17067},
'2026-01':{uhs:342,fat:536294,res:159532},
};

const gK='l26g3',oK='l26o3',cK='l26c3';
const gS=()=>{try{return JSON.parse(localStorage.getItem(gK))||{}}catch{return{}}};
const oS=()=>{try{return JSON.parse(localStorage.getItem(oK))||{}}catch{return{}}};
const cS=()=>{try{return JSON.parse(localStorage.getItem(cK))||{}}catch{return{}}};
const gW=d=>localStorage.setItem(gK,JSON.stringify(d));
const oW=d=>localStorage.setItem(oK,JSON.stringify(d));
const cW=d=>localStorage.setItem(cK,JSON.stringify(d));
const cm=()=>document.getElementById('mSel').value;
const ml=k=>{const[y,m]=k.split('-');return MP[+m]+'/'+y.slice(2)};
const tt=m=>+m.split('-')[1]<=6?T.s1:T.s2;
const gD=m=>gS()[m]||BL[m]||null;
const oD=m=>oS()[m]||null;
const cD=m=>cS()[m]||null;
const V=[
  {id:'bruno',n:'Bruno Neves',blA:177,blO:80,blD:30},
  {id:'gustavo',n:'Gustavo Barbosa',blA:76,blO:35,blD:12},
  {id:'camila',n:'Camila Madeira',blA:73,blO:33,blD:15},
  {id:'mariano',n:'Mariano',blA:30,blO:20,blD:3},
  {id:'briane',n:'Briane',blA:25,blO:14,blD:2},
  {id:'gabriel',n:'Gabriel',blA:20,blO:7,blD:5},
];
const aM=()=>[...new Set([...Object.keys(BL),...Object.keys(gS())])].sort();

(function(){const s=document.getElementById('mSel');for(let m=1;m<=12;m++){const v=`2026-${String(m).padStart(2,'0')}`;s.innerHTML+=`<option value="${v}"${m===2?' selected':''}>${MP[m]} 2026</option>`}s.addEventListener('change',render)})();

// Helpers
const fR=v=>v>=1e6?'R$'+(v/1e6).toFixed(1)+'M':v>=1000?'R$'+(v/1000).toFixed(0)+'k':'R$'+Math.round(v);
const pct=(v,t,inv)=>{if(!v||!t)return 0;let p=inv?(t/v*100):(v/t*100);return Math.min(Math.max(p,0),100)};
const sc=(v,t,inv)=>{if(!v||!t)return'a';let p=inv?(t/v*100):(v/t*100);return p>=90?'g':p>=70?'a':'r'};
const dc=s=>s==='g'?'dot-g':s==='r'?'dot-r':'dot-a';
const bc=s=>s==='g'?'badge-g':s==='r'?'badge-r':'badge-a';
const bl=s=>s==='g'?'No alvo':s==='r'?'Atenção':'Quase lá';
const vc=s=>s==='g'?'var(--green)':s==='r'?'var(--red)':'var(--amber)';

function tSujo(o){if(!o)return null;let s=0,h=false;E.forEach(e=>{if(o[e.id]&&o[e.id].sujo!=null){s+=o[e.id].sujo;h=true}});return h?s:null}
function aCO(o){if(!o)return null;let s=0,n=0;E.forEach(e=>{if(o[e.id]&&o[e.id].co){s+=o[e.id].co;n++}});return n?s/n:null}
function aN(o){if(!o)return null;let s=0,n=0;E.forEach(e=>{if(o[e.id]&&o[e.id].nota){s+=o[e.id].nota;n++}});return n?s/n:null}

// === RENDER ===
function render(){const m=cm(),g=gD(m),o=oD(m),c=cD(m),t=tt(m);rOp(g,o,t);rCom(g,c,t);rDir(g,o,t);rHist()}

function rOp(g,o,t){
  const d=g||{};
  let html='';
  SUPS.forEach((sup,si)=>{
    const emps=sup.emps.map(id=>E.find(e=>e.id===id));
    let sS=0,coS=0,coN=0,nS=0,nN=0,cosT=0;
    emps.forEach(e=>{const x=o&&o[e.id]||{};if(x.sujo!=null)sS+=x.sujo;if(x.co){coS+=x.co;coN++}if(x.nota){nS+=x.nota;nN++}if(x.cos)cosT+=x.cos});
    const avgCo=coN?coS/coN:null,avgN=nN?nS/nN:null;
    const coSt=sc(avgCo,t.co,true),sujoSt=sS===0&&o?'g':sS>0?'r':'a',nSt=sc(avgN,t.nota);
    const allG=coSt==='g'&&sujoSt==='g'&&nSt==='g';const anyR=coSt==='r'||sujoSt==='r'||nSt==='r';
    const badge=allG?'g':anyR?'r':'a';
    let bonus=0;if(avgCo&&avgCo<=t.co)bonus+=1200;if(sS===0&&emps.some(e=>o&&o[e.id]&&o[e.id].sujo!=null))bonus+=800;if(avgN&&avgN>=8.5)bonus+=500;
    const planOk=emps.every(e=>o&&o[e.id]&&o[e.id].plan===100);if(planOk)bonus+=500;
    let ativ=0;emps.forEach(e=>{if(o&&o[e.id]&&o[e.id].ativ)ativ+=o[e.id].ativ});bonus+=ativ*100;
    const supColors=['var(--accent)','var(--green)','var(--amber)','var(--purple)','var(--red)'];
    const supColor=supColors[si%supColors.length];

    html+=`<div class="cluster" style="border-top:2px solid ${supColor}"><div class="cluster-head"><div class="cluster-name"><span class="ico" style="color:${supColor}">●</span>${sup.name}</div><div class="cluster-badge ${bc(badge)}">${bl(badge)}</div></div>`;
    html+=`<div class="cluster-kpis">
      <div class="ckpi"><div class="ckpi-l">CO Médio</div><div class="ckpi-v" style="color:${vc(coSt)}">${avgCo?'R$'+avgCo.toFixed(0):'--'}</div></div>
      <div class="ckpi"><div class="ckpi-l">Sujos</div><div class="ckpi-v" style="color:${vc(sujoSt)}">${o?sS:'--'}</div></div>
      <div class="ckpi"><div class="ckpi-l">Nota</div><div class="ckpi-v" style="color:${vc(nSt)}">${avgN?avgN.toFixed(1):'--'}</div></div>
      <div class="ckpi"><div class="ckpi-l">Bônus</div><div class="ckpi-v" style="color:var(--purple)">R$${bonus.toLocaleString()}</div></div>
    </div>`;
    html+=`<div class="emp-list"><div class="emp-row hdr"><div>Empreendimento</div><div style="text-align:center">CO</div><div style="text-align:center">Sujo</div><div style="text-align:center">Nota</div><div style="text-align:center">Plan</div></div>`;
    emps.forEach(e=>{const x=o&&o[e.id]||{};
      const coC=x.co?x.co<=t.co?'var(--green)':x.co<=43?'var(--amber)':'var(--red)':'var(--text2)';
      const sC=x.sujo===0?'var(--green)':x.sujo>0?'var(--red)':'var(--text2)';
      const nC=x.nota?x.nota>=8.5?'var(--green)':x.nota>=8?'var(--amber)':'var(--red)':'var(--text2)';
      html+=`<div class="emp-row"><div class="emp-name"><span class="dot ${x.co?dc(sc(x.co,t.co,true)):dc('a')}"></span>${e.n}</div><div class="emp-val" style="color:${coC}">${x.co?'R$'+x.co.toFixed(0):'--'}</div><div class="emp-val" style="color:${sC}">${x.sujo!=null?x.sujo:'--'}</div><div class="emp-val" style="color:${nC}">${x.nota||'--'}</div><div class="emp-val">${x.plan?x.plan+'%':'--'}</div></div>`;
    });
    html+=`</div></div>`;
  });
  document.getElementById('clusters').innerHTML=html;

  const mg=d.fat&&d.res?(d.res/d.fat*100):0;
  const fatUh=d.fat&&d.uhs?(d.fat/d.uhs):0;
  const lucUh=d.res&&d.uhs?(d.res/d.uhs):0;
  const co=aCO(o);const sujo=tSujo(o);
  const kpis=[
    {l:'UHs REPASSE',v:d.uhs||'--',tg:`Meta ${t.uhs}`,p:pct(d.uhs,t.uhs),bc:'var(--accent)'},
    {l:'FATURAMENTO',v:d.fat?fR(d.fat):'--',tg:`Meta ${fR(t.fat)}`,p:pct(d.fat,t.fat),bc:'var(--green)'},
    {l:'MARGEM',v:mg?mg.toFixed(1)+'%':'--',tg:`Meta ${t.mg}%`,p:pct(mg,t.mg),bc:mg>=t.mg?'var(--green)':'var(--amber)'},
    {l:'FAT/UH',v:fatUh?'R$'+Math.round(fatUh):'--',tg:`Meta R$${t.fatUh}`,p:pct(fatUh,t.fatUh),bc:'var(--cyan)'},
    {l:'LUCRO/UH',v:lucUh?'R$'+Math.round(lucUh):'--',tg:`Meta R$${t.lucUh}`,p:pct(lucUh,t.lucUh),bc:lucUh>=t.lucUh?'var(--green)':'var(--purple)'},
    {l:'CUSTO/CO',v:co?'R$'+co.toFixed(0):'--',tg:`Meta ≤R$${t.co}`,p:pct(co,t.co,true),bc:co&&co<=t.co?'var(--green)':'var(--red)'},
  ];
  document.getElementById('opKpis').innerHTML=kpis.map(k=>`<div class="mkpi"><div class="mkpi-l">${k.l}</div><div class="mkpi-v">${k.v}</div><div class="mkpi-t">${k.tg}</div><div class="mkpi-bar"><div class="mkpi-bar-f" style="width:${k.p}%;background:${k.bc}"></div></div></div>`).join('');
}

function rDir(g,o,t){
  const d=g||{};const mg=d.fat&&d.res?(d.res/d.fat*100):0;const co=aCO(o);const sujo=tSujo(o);const nota=aN(o);
  const fatUh=d.fat&&d.uhs?(d.fat/d.uhs):0;const lucUh=d.res&&d.uhs?(d.res/d.uhs):0;
  const kpis=[
    {l:'UHs',v:d.uhs||'--',tg:`${t.uhs}`,p:pct(d.uhs,t.uhs),bc:'var(--accent)'},
    {l:'FATURAMENTO',v:d.fat?fR(d.fat):'--',tg:fR(t.fat),p:pct(d.fat,t.fat),bc:'var(--green)'},
    {l:'MARGEM',v:mg?mg.toFixed(1)+'%':'--',tg:`${t.mg}%`,p:pct(mg,t.mg),bc:mg>=t.mg?'var(--green)':'var(--amber)'},
    {l:'FAT/UH',v:fatUh?'R$'+Math.round(fatUh):'--',tg:`R$${t.fatUh}`,p:pct(fatUh,t.fatUh),bc:'var(--cyan)'},
    {l:'LUCRO/UH',v:lucUh?'R$'+Math.round(lucUh):'--',tg:`R$${t.lucUh}`,p:pct(lucUh,t.lucUh),bc:'var(--purple)'},
    {l:'CUSTO/CO',v:co?'R$'+co.toFixed(0):'--',tg:`≤R$${t.co}`,p:pct(co,t.co,true),bc:co&&co<=t.co?'var(--green)':'var(--red)'},
    {l:'SUJOS',v:sujo!=null?sujo:'--',tg:'0',p:sujo===0?100:sujo>0?0:50,bc:sujo===0?'var(--green)':'var(--red)'},
  ];
  document.getElementById('dirKpis').innerHTML=kpis.map(k=>`<div class="mkpi"><div class="mkpi-l">${k.l}</div><div class="mkpi-v">${k.v}</div><div class="mkpi-t">Meta: ${k.tg}</div><div class="mkpi-bar"><div class="mkpi-bar-f" style="width:${k.p}%;background:${k.bc}"></div></div></div>`).join('');

  const pts=aM().map(m=>({month:m,...(gD(m)||{})})).filter(x=>x.uhs);
  rChUhs(pts,t);rChMarg(pts,t);rDirBonus(d);

  const areas=[
    {n:'Comercial',metrics:[{l:'Novas UHs repasse',v:d.novas||'--',s:sc(d.novas,t.novas)},{l:'Assinaturas',v:d.assin||'--',s:sc(d.assin,t.assin)},{l:'Fat/UH',v:fatUh?'R$'+Math.round(fatUh):'--',s:sc(fatUh,t.fatUh)}]},
    {n:'Operacional',metrics:[{l:'Custo/CO',v:co?'R$'+co.toFixed(0):'--',s:sc(co,t.co,true)},{l:'Quartos sujos',v:sujo!=null?sujo:'--',s:sujo===0?'g':sujo>0?'r':'a'},{l:'Nota',v:nota?nota.toFixed(1):'--',s:sc(nota,t.nota)}]},
    {n:'Eficiência',metrics:[{l:'Lucro/UH',v:lucUh?'R$'+Math.round(lucUh):'--',s:sc(lucUh,t.lucUh)},{l:'Margem',v:mg?mg.toFixed(1)+'%':'--',s:sc(mg,t.mg)},{l:'Ocupação',v:d.ocup?d.ocup+'%':'--',s:sc(d.ocup,85)}]},
    {n:'RI',metrics:[{l:'Churn',v:d.churn?d.churn+'%':'--',s:sc(d.churn,t.churn,true)},{l:'NPS',v:d.nps||'--',s:sc(d.nps,60)},{l:'Reports',v:d.rep?d.rep+'%':'--',s:sc(d.rep,100)}]},
  ];
  document.getElementById('dirAreas').innerHTML=areas.map(a=>{
    const allG=a.metrics.every(m=>m.s==='g'),anyR=a.metrics.some(m=>m.s==='r');const b=allG?'g':anyR?'r':'a';
    return`<div class="area-card"><div class="area-hdr"><div class="area-nm">${a.n}</div><div class="cluster-badge ${bc(b)}">${bl(b)}</div></div>${a.metrics.map(m=>`<div class="area-row"><span class="area-rl"><span class="dot ${dc(m.s)}"></span>${m.l}</span><span class="area-rv">${m.v}</span></div>`).join('')}</div>`;
  }).join('');
}

// === MULTI-YEAR CHART ===
const YC={'2023':'#878787','2024':'#b45309','2025':'#2563eb','2026':'#000000'};
function yearSeries(field){
  const all=aM().map(m=>({month:m,...(gD(m)||{})})).filter(x=>x.uhs);
  const yrs={};all.forEach(d=>{const y=d.month.split('-')[0];if(!yrs[y])yrs[y]=[];yrs[y].push({...d,mi:+d.month.split('-')[1]})});
  Object.values(yrs).forEach(a=>a.sort((a,b)=>a.mi-b.mi));return yrs;
}

function rChUhs(pts,t){
  const el=document.getElementById('chUhs');const W=el.offsetWidth||400,H=el.offsetHeight||160;
  const PL=32,PR=10,PT=16,PB=18,cw=W-PL-PR,ch=H-PT-PB;
  const yrs=yearSeries('uhs');const yrKeys=Object.keys(yrs).sort();
  if(!yrKeys.length){el.innerHTML='<div style="color:var(--text2);font-size:12px;padding:20px">Sem dados</div>';return}
  let allV=[];yrKeys.forEach(y=>yrs[y].forEach(d=>allV.push(d.uhs)));
  const mx=Math.max(t.uhs+30,...allV),mn=Math.min(...allV)*.88;
  let svg='';
  for(let m=1;m<=12;m++){const x=PL+((m-1)/11)*cw;svg+=`<text x="${x}" y="${H-3}" text-anchor="middle" fill="var(--text2)" font-size="9" font-weight="600" font-family="Syne">${MP[m].substring(0,3)}</text>`}
  const ty=PT+ch-((t.uhs-mn)/(mx-mn))*ch;
  svg+=`<line x1="${PL}" y1="${ty}" x2="${W-PR}" y2="${ty}" stroke="var(--green)" stroke-width="1.5" stroke-dasharray="4,3" opacity=".5"/><text x="${W-PR}" y="${ty-3}" text-anchor="end" fill="var(--green)" font-size="9" font-weight="700">${t.uhs}</text>`;
  yrKeys.forEach(yr=>{
    const ds=yrs[yr];const c=YC[yr]||'#888';const last=yr===yrKeys[yrKeys.length-1];
    let path='',dots='';
    ds.forEach((d,i)=>{const x=PL+((d.mi-1)/11)*cw,y=PT+ch-((d.uhs-mn)/(mx-mn))*ch;
      path+=(i===0?'M':'L')+` ${x} ${y}`;
      if(last)dots+=`<circle cx="${x}" cy="${y}" r="4" fill="${c}" stroke="white" stroke-width="2"/><text x="${x}" y="${y-10}" text-anchor="middle" fill="${c}" font-size="10" font-weight="700" font-family="Space Mono">${d.uhs}</text>`;
      else dots+=`<circle cx="${x}" cy="${y}" r="2" fill="${c}" opacity=".6"/>`;
    });
    svg+=`<path d="${path}" fill="none" stroke="${c}" stroke-width="${last?3.5:2}" opacity="${last?1:.4}" stroke-linejoin="round"/>${dots}`;
  });
  let lx=PL;yrKeys.forEach(yr=>{const c=YC[yr]||'#888';svg+=`<line x1="${lx}" y1="5" x2="${lx+14}" y2="5" stroke="${c}" stroke-width="3" stroke-linecap="round"/><text x="${lx+17}" y="8" fill="${c}" font-size="9" font-weight="700" font-family="Syne">${yr}</text>`;lx+=46});
  el.innerHTML=`<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}">${svg}</svg>`;
}

function rChMarg(pts,t){
  const el=document.getElementById('chMarg');const W=el.offsetWidth||300,H=el.offsetHeight||160;
  const PL=30,PR=8,PT=16,PB=18,cw=W-PL-PR,ch=H-PT-PB;
  const yrs=yearSeries('res');const yrKeys=Object.keys(yrs).sort();
  if(!yrKeys.length){el.innerHTML='<div style="color:var(--text2);font-size:12px;padding:20px">Sem dados</div>';return}
  let allM=[];yrKeys.forEach(y=>yrs[y].forEach(d=>{if(d.fat)allM.push(d.res/d.fat*100)}));
  const mx=Math.max(45,...allM),mn=Math.min(-45,...allM);
  const zy=PT+ch-((0-mn)/(mx-mn))*ch;
  let svg=`<line x1="${PL}" y1="${zy}" x2="${W-PR}" y2="${zy}" stroke="var(--text2)" stroke-width=".8" opacity=".2"/>`;
  for(let m=1;m<=12;m++){const x=PL+((m-1)/11)*cw;svg+=`<text x="${x}" y="${H-3}" text-anchor="middle" fill="var(--text2)" font-size="9" font-weight="600" font-family="Syne">${MP[m].substring(0,3)}</text>`}
  const t15=PT+ch-((t.mg-mn)/(mx-mn))*ch;
  svg+=`<line x1="${PL}" y1="${t15}" x2="${W-PR}" y2="${t15}" stroke="var(--green)" stroke-width="1.5" stroke-dasharray="3,3" opacity=".5"/><text x="${W-PR}" y="${t15-3}" text-anchor="end" fill="var(--green)" font-size="9" font-weight="700">${t.mg}%</text>`;
  yrKeys.forEach(yr=>{
    const ds=yrs[yr].filter(d=>d.fat);const c=YC[yr]||'#888';const last=yr===yrKeys[yrKeys.length-1];
    let path='',dots='';
    ds.forEach((d,i)=>{const mg=d.res/d.fat*100;const x=PL+((d.mi-1)/11)*cw,y=PT+ch-((mg-mn)/(mx-mn))*ch;
      path+=(i===0?'M':'L')+` ${x} ${y}`;
      if(last){const fc=mg>=15?'var(--green)':mg>=0?'var(--amber)':'var(--red)';dots+=`<circle cx="${x}" cy="${y}" r="4" fill="${fc}" stroke="white" stroke-width="2"/><text x="${x}" y="${y+(mg<0?14:-10)}" text-anchor="middle" fill="${fc}" font-size="9" font-weight="700" font-family="Space Mono">${mg.toFixed(0)}%</text>`}
      else dots+=`<circle cx="${x}" cy="${y}" r="2" fill="${c}" opacity=".6"/>`;
    });
    svg+=`<path d="${path}" fill="none" stroke="${c}" stroke-width="${last?3.5:2}" opacity="${last?1:.4}" stroke-linejoin="round"/>${dots}`;
  });
  let lx=PL;yrKeys.forEach(yr=>{const c=YC[yr]||'#888';svg+=`<line x1="${lx}" y1="5" x2="${lx+14}" y2="5" stroke="${c}" stroke-width="3" stroke-linecap="round"/><text x="${lx+17}" y="8" fill="${c}" font-size="9" font-weight="700" font-family="Syne">${yr}</text>`;lx+=46});
  el.innerHTML=`<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}">${svg}</svg>`;
}

function rDirBonus(d){
  const res=d.res||0,rA=res*12,pool=rA*.2,perD=pool/4;
  const assin=d.assin||0,novas=d.novas||0;
  const cA=assin*150,cO=novas*250,oR=novas*100,tot=cA+cO+oR;
  document.getElementById('dirBonus').innerHTML=`<div style="display:flex;flex-direction:column;gap:8px;font-size:11px;height:100%;justify-content:center">
    <div style="padding:12px;background:var(--bg3);border-radius:12px;border-left:3px solid var(--purple)">
      <div style="font-weight:700;color:var(--purple);margin-bottom:6px;font-size:10px;text-transform:uppercase;letter-spacing:.5px">Bônus Diretores (20% lucro)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <div><span style="color:var(--text2)">Resultado:</span> <span style="font-family:'Space Mono';font-weight:700">${fR(res)}/mês</span></div>
        <div><span style="color:var(--text2)">Anualizado:</span> <span style="font-family:'Space Mono';font-weight:700">${fR(rA)}</span></div>
        <div><span style="color:var(--text2)">Pool 20%:</span> <span style="font-family:'Space Mono';font-weight:700">${fR(pool)}</span></div>
        <div><span style="color:var(--text2)">Por diretor:</span> <span style="font-family:'Space Mono';font-weight:700;color:${perD>50000?'var(--green)':'var(--text)'}">${fR(perD)}</span></div>
      </div>
      <div style="color:var(--text2);font-size:9px;margin-top:4px">Ernesto · Tiago · Milene · Bruno</div>
    </div>
    <div style="padding:12px;background:var(--bg3);border-radius:12px;border-left:3px solid var(--cyan)">
      <div style="font-weight:700;color:var(--cyan);margin-bottom:6px;font-size:10px;text-transform:uppercase;letter-spacing:.5px">Comissões do Mês</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <div><span style="color:var(--text2)">Assin. ${assin}×R$150:</span> <span style="font-family:'Space Mono';font-weight:700;color:var(--accent)">${fR(cA)}</span></div>
        <div><span style="color:var(--text2)">Oper. ${novas}×R$250:</span> <span style="font-family:'Space Mono';font-weight:700;color:var(--green)">${fR(cO)}</span></div>
        <div><span style="color:var(--text2)">Prédio ${novas}×R$100:</span> <span style="font-family:'Space Mono';font-weight:700;color:var(--amber)">${fR(oR)}</span></div>
        <div><span style="color:var(--text2)">Total:</span> <span style="font-family:'Space Mono';font-weight:700;font-size:13px">${fR(tot)}</span></div>
      </div>
    </div>
  </div>`;
}

function rCom(g,c,t){
  const d=g||{};
  const novas=d.novas||0,assin=d.assin||0;
  let totalOp=0,totalEl=0;
  V.forEach(v=>{const x=c&&c[v.id]||{};const a=x.assin!=null?x.assin:v.blA;const o=x.oper!=null?x.oper:v.blO;const dt=x.dist!=null?x.dist:v.blD;const el=a-dt;totalOp+=o;totalEl+=el});
  const avgAtiv=totalEl>0?(totalOp/totalEl*100):0;

  const kpis=[
    {l:'NOVAS UHs REPASSE',sub:'Peso 50%',v:novas||'--',tg:`Meta ≥${t.novas}/mês`,p:pct(novas,t.novas),bc:'var(--accent)'},
    {l:'ASSINATURAS',sub:'Peso 20%',v:assin||'--',tg:`Meta ≥${t.assin}/mês`,p:pct(assin,t.assin),bc:'var(--cyan)'},
    {l:'TAXA ATIVAÇÃO MÉDIA',sub:'Peso 30%',v:avgAtiv?avgAtiv.toFixed(0)+'%':'--',tg:'Meta ≥75%',p:pct(avgAtiv,75),bc:avgAtiv>=75?'var(--green)':avgAtiv>=60?'var(--amber)':'var(--red)'},
  ];
  document.getElementById('comKpis').innerHTML=kpis.map(k=>`<div class="mkpi"><div class="mkpi-l">${k.l} <span style="color:var(--purple);font-size:8px;font-weight:700">${k.sub}</span></div><div class="mkpi-v">${k.v}</div><div class="mkpi-t">${k.tg}</div><div class="mkpi-bar"><div class="mkpi-bar-f" style="width:${k.p}%;background:${k.bc}"></div></div></div>`).join('');

  let cards='';
  V.forEach(v=>{
    const x=c&&c[v.id]||{};
    const a=x.assin!=null?x.assin:v.blA;
    const o=x.oper!=null?x.oper:v.blO;
    const dt=x.dist!=null?x.dist:v.blD;
    const el=a-dt;const rate=el>0?(o/el*100):0;
    const rateSt=rate>=75?'g':rate>=60?'a':'r';
    const novasV=x.novas_mes||0;const assinV=x.assin_mes||0;
    const comA=assinV*150,comO=novasV*250,comTot=comA+comO;
    const bonusTrim=rate>80?'✓':'✗';

    cards+=`<div class="vcard">
      <div class="vcard-head"><div class="vcard-name">${v.n}</div><div class="cluster-badge ${bc(rateSt)}">${rate.toFixed(0)}%</div></div>
      <div class="vcard-rate" style="color:${vc(rateSt)}">${rate.toFixed(1)}%</div>
      <div style="font-size:9px;color:var(--text2);text-align:center;margin-bottom:2px;font-weight:600;text-transform:uppercase;letter-spacing:.3px">Taxa Ativação</div>
      <div class="vcard-bar"><div class="vcard-bar-f" style="width:${Math.min(rate/75*100,100)}%;background:${vc(rateSt)}"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text2);margin-bottom:6px;font-weight:600"><span>${o} oper.</span><span>${el} eleg.</span><span>${dt} dist.</span></div>
      <div class="vcard-stats">
        <div class="vcard-stat"><div class="vcard-stat-l">Assin. mês</div><div class="vcard-stat-v">${assinV||'--'}</div></div>
        <div class="vcard-stat"><div class="vcard-stat-l">Novas rep.</div><div class="vcard-stat-v">${novasV||'--'}</div></div>
        <div class="vcard-stat"><div class="vcard-stat-l">Comissão</div><div class="vcard-stat-v" style="color:var(--green)">${comTot?fR(comTot):'--'}</div></div>
        <div class="vcard-stat"><div class="vcard-stat-l">Bônus 80%</div><div class="vcard-stat-v" style="color:${rate>80?'var(--green)':'var(--text2)'}">${bonusTrim}</div></div>
      </div>
    </div>`;
  });
  document.getElementById('comCards').innerHTML=cards;

  const totAssin=V.reduce((s,v)=>{const x=c&&c[v.id]||{};return s+(x.assin_mes||0)},0);
  const totNovas=V.reduce((s,v)=>{const x=c&&c[v.id]||{};return s+(x.novas_mes||0)},0);
  const cA=totAssin*150,cO=totNovas*250,oR=totNovas*100,totC=cA+cO+oR;

  document.getElementById('comBottom').innerHTML=`
    <div class="dir-chart" style="padding:12px">
      <div class="dir-chart-title"><div class="cdot" style="background:var(--purple)"></div>Comissões do Mês</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:11px">
        <div class="ckpi"><div class="ckpi-l">ASSIN. ×R$150</div><div class="ckpi-v" style="color:var(--accent);font-size:14px">${fR(cA)}</div></div>
        <div class="ckpi"><div class="ckpi-l">OPER. ×R$250</div><div class="ckpi-v" style="color:var(--green);font-size:14px">${fR(cO)}</div></div>
        <div class="ckpi"><div class="ckpi-l">PRÉDIO ×R$100</div><div class="ckpi-v" style="color:var(--amber);font-size:14px">${fR(oR)}</div></div>
        <div class="ckpi"><div class="ckpi-l">TOTAL</div><div class="ckpi-v" style="color:var(--text);font-size:14px">${fR(totC)}</div></div>
      </div>
    </div>
    <div class="dir-chart" style="padding:12px">
      <div class="dir-chart-title"><div class="cdot" style="background:var(--cyan)"></div>Pipeline (acumulado)</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:11px">
        <div class="ckpi"><div class="ckpi-l">ASSINADOS</div><div class="ckpi-v" style="font-size:14px">${V.reduce((s,v)=>{const x=c&&c[v.id]||{};return s+(x.assin!=null?x.assin:v.blA)},0)}</div></div>
        <div class="ckpi"><div class="ckpi-l">OPERANDO</div><div class="ckpi-v" style="color:var(--green);font-size:14px">${totalOp}</div></div>
        <div class="ckpi"><div class="ckpi-l">ELEGÍVEIS</div><div class="ckpi-v" style="color:var(--cyan);font-size:14px">${totalEl}</div></div>
        <div class="ckpi"><div class="ckpi-l">GAP</div><div class="ckpi-v" style="color:var(--red);font-size:14px">${totalEl-totalOp}</div></div>
      </div>
    </div>`;
}

function rHist(){
  const months=aM();
  let h='<thead><tr style="border-bottom:2px solid var(--border)"><th style="padding:6px;text-align:left">MÊS</th><th>ANO</th><th>UHs</th><th>FAT.</th><th>RESULT.</th><th>MARGEM</th><th>FAT/UH</th><th>LUCRO/UH</th><th>CO</th><th>SUJOS</th><th>NOTA</th><th>ASSIN.</th><th>NOVAS</th><th>CHURN</th></tr></thead><tbody>';
  [...months].reverse().forEach(m=>{
    const d=gD(m),o=oD(m);if(!d)return;
    const yr=m.split('-')[0];const yc=YC[yr]||'var(--text2)';
    const mg=d.fat?(d.res/d.fat*100):0,co=aCO(o),sujo=tSujo(o),nota=aN(o);
    const fU=d.fat&&d.uhs?Math.round(d.fat/d.uhs):null,lU=d.res&&d.uhs?Math.round(d.res/d.uhs):null;
    h+=`<tr style="border-bottom:1px solid var(--bg3);border-left:3px solid ${yc}"><td style="padding:6px;font-weight:700;font-size:11px">${ml(m)}</td>
    <td style="padding:5px;text-align:center;font-size:10px;font-weight:700;color:${yc}">${yr}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${d.uhs||'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${d.fat?fR(d.fat):'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px;color:${d.res>=0?'var(--green)':'var(--red)'}">${d.res!=null?fR(d.res):'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px;color:${mg>=15?'var(--green)':mg>=0?'var(--amber)':'var(--red)'}">${mg?mg.toFixed(1)+'%':'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px;color:var(--cyan)">${fU?'R$'+fU:'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px;color:var(--purple)">${lU?'R$'+lU:'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${co?'R$'+co.toFixed(0):'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px;color:${sujo===0?'var(--green)':sujo>0?'var(--red)':'inherit'}">${sujo!=null?sujo:'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${nota?nota.toFixed(1):'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${d.assin||'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${d.novas||'--'}</td>
    <td style="padding:5px;text-align:center;font-family:'Space Mono';font-size:11px">${d.churn?d.churn+'%':'--'}</td></tr>`;
  });
  document.getElementById('hTbl').innerHTML=h+'</tbody>';
}

// === MODALS ===
function buildOF(){
  const m=cm(),od=oD(m)||{};let h='';
  SUPS.forEach(sup=>{
    h+=`<div class="fsec"><div class="fsec-t">${sup.name}</div>`;
    sup.emps.forEach(id=>{const e=E.find(x=>x.id===id);const d=od[id]||{};
      h+=`<div class="emp-hdr">${e.n} <span style="color:var(--text2);font-weight:400">(bl: R$${e.bl})</span></div>`;
      h+=`<div class="frow3"><div class="fg"><label>Custo/CO (R$)</label><input type="number" step="0.01" id="op_${id}_co" value="${d.co||''}"></div>`;
      h+=`<div class="fg"><label>Quartos Sujos</label><input type="number" id="op_${id}_sujo" value="${d.sujo!=null?d.sujo:''}"></div>`;
      h+=`<div class="fg"><label>Nota Qualidade</label><input type="number" step="0.1" id="op_${id}_nota" value="${d.nota||''}"></div></div>`;
      h+=`<div class="frow3"><div class="fg"><label>Checkouts</label><input type="number" id="op_${id}_cos" value="${d.cos||''}"></div>`;
      h+=`<div class="fg"><label>UHs Ativadas</label><input type="number" id="op_${id}_ativ" value="${d.ativ||''}"></div>`;
      h+=`<div class="fg"><label>Planilha (%)</label><input type="number" id="op_${id}_plan" value="${d.plan||''}"></div></div>`;
    });h+=`</div>`;
  });
  document.getElementById('oForm').innerHTML=h;
}

function buildCF(){
  const m=cm(),cd=cD(m)||{};let h='';
  V.forEach(v=>{const d=cd[v.id]||{};
    h+=`<div class="fsec"><div class="fsec-t">${v.n} <span style="color:var(--text2);font-weight:400">(bl: ${v.blA} assin, ${v.blO} oper, ${v.blD} dist)</span></div>`;
    h+=`<div class="frow3"><div class="fg"><label>Total Assinados (acum.)</label><input type="number" id="c_${v.id}_assin" value="${d.assin!=null?d.assin:''}"></div>`;
    h+=`<div class="fg"><label>Total Operando (acum.)</label><input type="number" id="c_${v.id}_oper" value="${d.oper!=null?d.oper:''}"></div>`;
    h+=`<div class="fg"><label>Total Distratos (acum.)</label><input type="number" id="c_${v.id}_dist" value="${d.dist!=null?d.dist:''}"></div></div>`;
    h+=`<div class="frow3"><div class="fg"><label>Assinaturas no Mês</label><input type="number" id="c_${v.id}_assin_mes" value="${d.assin_mes||''}"></div>`;
    h+=`<div class="fg"><label>Novas UHs no Repasse (mês)</label><input type="number" id="c_${v.id}_novas_mes" value="${d.novas_mes||''}"></div>`;
    h+=`<div class="fg"><label></label></div></div></div>`;
  });
  document.getElementById('cForm').innerHTML=h;
}
function saveC(){const m=cm(),data=cS(),entry={};V.forEach(v=>{const d={};['assin','oper','dist','assin_mes','novas_mes'].forEach(f=>{const el=document.getElementById(`c_${v.id}_${f}`);if(el&&el.value!=='')d[f]=parseFloat(el.value)});if(Object.keys(d).length)entry[v.id]=d});data[m]=entry;cW(data);closeM();render()}

function openM(t){
  const m=cm();
  if(t==='g'){document.getElementById('mGm').textContent=MP[+m.split('-')[1]]+' 2026';const d=gD(m)||{};['uhs','fat','res','ocup','assin','novas','distr','churn','nps','rep','tresp'].forEach(f=>{const el=document.getElementById('g_'+f);if(el)el.value=d[f]||''});document.getElementById('mG').classList.add('show')}
  else if(t==='c'){document.getElementById('mCm').textContent=MP[+m.split('-')[1]]+' 2026';buildCF();document.getElementById('mC').classList.add('show')}
  else{document.getElementById('mOm').textContent=MP[+m.split('-')[1]]+' 2026';buildOF();document.getElementById('mO').classList.add('show')}
}
function closeM(){document.querySelectorAll('.modal-ov').forEach(m=>m.classList.remove('show'))}
function saveG(){const m=cm(),data=gS(),e={};['uhs','fat','res','ocup','assin','novas','distr','churn','nps','rep','tresp'].forEach(f=>{const el=document.getElementById('g_'+f);if(el&&el.value!=='')e[f]=parseFloat(el.value)});data[m]=e;gW(data);closeM();render()}
function saveO(){const m=cm(),data=oS(),entry={};E.forEach(e=>{const d={};['co','sujo','nota','cos','ativ','plan'].forEach(f=>{const el=document.getElementById(`op_${e.id}_${f}`);if(el&&el.value!=='')d[f]=parseFloat(el.value)});if(Object.keys(d).length)entry[e.id]=d});data[m]=entry;oW(data);closeM();render()}
function delM(t){const m=cm();if(!confirm(`Apagar ${ml(m)}?`))return;if(t==='g'){const d=gS();delete d[m];gW(d)}else if(t==='c'){const d=cS();delete d[m];cW(d)}else{const d=oS();delete d[m];oW(d)}closeM();render()}

function sw(el,v){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');['op','com','dir','cfg','hist'].forEach(id=>document.getElementById(id+'V').classList.toggle('active',id===v));if(v==='cfg')rCfg();render()}
function toggleTV(){document.body.classList.toggle('tv')}

// === CONFIG / GESTÃO ===
function rCfg(){
  let sh='';
  SUPS.forEach((sup,si)=>{
    const assigned=sup.emps.map(id=>E.find(e=>e.id===id)).filter(Boolean);
    const unassigned=E.filter(e=>!SUPS.some(s=>s.emps.includes(e.id)));
    const supColors=['var(--accent)','var(--green)','var(--amber)','var(--purple)','var(--red)'];
    sh+=`<div class="cfg-sup" style="border-left-color:${supColors[si%supColors.length]}">
      <div class="cfg-sup-head">
        <div class="cfg-sup-name">● ${sup.name}</div>
        <div style="display:flex;gap:4px"><button class="btn btn-o" style="font-size:9px;padding:3px 10px" onclick="renameSup(${si})">Editar</button><button class="btn" style="background:var(--red);color:#fff;font-size:9px;padding:3px 10px;border-color:var(--red)" onclick="delSup(${si})">✕</button></div>
      </div>
      <div style="margin-bottom:6px">`;
    assigned.forEach(e=>{
      sh+=`<span class="cfg-emp-tag">${e.n}<span class="x" onclick="unassignEmp('${e.id}',${si})">✕</span></span>`;
    });
    sh+=`</div>`;
    if(unassigned.length){
      sh+=`<div style="display:flex;gap:4px;align-items:center"><select class="cfg-sel" id="cfgAdd${si}"><option value="">＋ Atribuir prédio...</option>`;
      unassigned.forEach(e=>{sh+=`<option value="${e.id}">${e.n}</option>`});
      sh+=`</select><button class="btn btn-p" style="font-size:10px;padding:4px 10px" onclick="assignEmp(${si})">Adicionar</button></div>`;
    }
    sh+=`</div>`;
  });
  const unassAll=E.filter(e=>!SUPS.some(s=>s.emps.includes(e.id)));
  if(unassAll.length){
    sh+=`<div style="margin-top:8px;padding:10px;background:#fef2f2;border:1px dashed var(--red);border-radius:12px"><div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:4px">Sem supervisor atribuído</div>`;
    unassAll.forEach(e=>{sh+=`<span class="cfg-emp-tag" style="border-color:var(--red)">${e.n}</span>`});
    sh+=`</div>`;
  }
  document.getElementById('cfgSups').innerHTML=sh;

  let eh='';
  E.forEach((e,ei)=>{
    const sup=SUPS.find(s=>s.emps.includes(e.id));
    eh+=`<div class="cfg-emp-row">
      <div style="font-weight:600">${e.n} <span style="color:var(--text2);font-size:10px">(bl: R$${e.bl})</span></div>
      <div style="display:flex;gap:4px;align-items:center">
        <select class="cfg-sel" onchange="moveEmp('${e.id}',this.value)">`;
    SUPS.forEach((s,si)=>{eh+=`<option value="${si}"${sup&&sup.name===s.name?' selected':''}>${s.name}</option>`});
    eh+=`<option value="-1"${!sup?' selected':''}>— Nenhum —</option></select>`;
    eh+=`<button class="btn" style="background:var(--red);color:#fff;font-size:9px;padding:3px 8px;border-color:var(--red)" onclick="delEmp(${ei})">✕</button></div></div>`;
  });
  document.getElementById('cfgEmps').innerHTML=eh;
}

function persistCfg(){saveCfg({emps:E,sups:SUPS});refreshCfg();rCfg();render()}

function addSup(){
  const name=prompt('Nome do novo supervisor:');if(!name||!name.trim())return;
  SUPS.push({name:name.trim(),ico:'●',emps:[]});persistCfg();
}
function renameSup(si){
  const name=prompt('Novo nome:',SUPS[si].name);if(!name||!name.trim())return;
  SUPS[si].name=name.trim();
  E.forEach(e=>{if(SUPS[si].emps.includes(e.id))e.s=name.trim()});
  persistCfg();
}
function delSup(si){
  if(!confirm(`Remover ${SUPS[si].name}? Os prédios ficarão sem supervisor.`))return;
  SUPS.splice(si,1);persistCfg();
}
function assignEmp(si){
  const sel=document.getElementById('cfgAdd'+si);const id=sel.value;if(!id)return;
  SUPS.forEach(s=>{s.emps=s.emps.filter(eid=>eid!==id)});
  SUPS[si].emps.push(id);
  const e=E.find(x=>x.id===id);if(e)e.s=SUPS[si].name;
  persistCfg();
}
function unassignEmp(id,si){
  SUPS[si].emps=SUPS[si].emps.filter(eid=>eid!==id);
  const e=E.find(x=>x.id===id);if(e)e.s='';
  persistCfg();
}
function moveEmp(id,si){
  si=parseInt(si);
  SUPS.forEach(s=>{s.emps=s.emps.filter(eid=>eid!==id)});
  if(si>=0&&si<SUPS.length){SUPS[si].emps.push(id);const e=E.find(x=>x.id===id);if(e)e.s=SUPS[si].name}
  else{const e=E.find(x=>x.id===id);if(e)e.s=''}
  persistCfg();
}
function addEmp(){
  const name=prompt('Nome do empreendimento:');if(!name||!name.trim())return;
  const bl=parseFloat(prompt('Custo baseline por checkout (R$):','40'))||40;
  const id=name.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  if(E.find(e=>e.id===id)){alert('Já existe!');return}
  E.push({id,n:name.trim(),s:'',bl});persistCfg();
}
function delEmp(ei){
  if(!confirm(`Remover ${E[ei].n}?`))return;
  const id=E[ei].id;SUPS.forEach(s=>{s.emps=s.emps.filter(eid=>eid!==id)});
  E.splice(ei,1);persistCfg();
}

render();
window.addEventListener('resize',render);
</script>
</body>
</html>
